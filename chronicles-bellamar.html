<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–•—Ä–æ–Ω–∏–∫–∏ –ë–µ–ª–ª–∞–º–∞—Ä–∞ ‚Äî Interactive Prototype</title>
<meta name="description" content="–•—Ä–æ–Ω–∏–∫–∏ –ë–µ–ª–ª–∞–º–∞—Ä–∞ ‚Äî –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–∞—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è —Ç–µ—Ä—Ä–∞–ø–µ–¥–∏—è (–ø—Ä–æ—Ç–æ—Ç–∏–ø). RU / EN / UZ / UY / DE. –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: TTS, high-contrast, large text, ARIA." />
<style>
  :root{
    --bg:#fbfbfb; --fg:#111; --accent:#2b6cb0; --muted:#666;
    --card-bg:#fff; --radius:12px; --gap:1rem;
    --max-width:1100px;
  }
  html,body{height:100%; margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial; background:var(--bg); color:var(--fg);}
  .container{max-width:var(--max-width); margin:0 auto; padding:1rem;}
  header{display:flex; gap:1rem; align-items:center; justify-content:space-between; margin-bottom:1rem;}
  .brand{display:flex; gap:0.75rem; align-items:center;}
  .logo{width:46px;height:46px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#9f7aea);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
  nav {display:flex; gap:.5rem; flex-wrap:wrap;}
  .lang-btn{padding:.4rem .6rem;border-radius:6px;border:1px solid #ddd;background:white;cursor:pointer}
  .controls{display:flex; gap:.5rem; align-items:center;}
  main{display:grid; grid-template-columns: 1fr 340px; gap:1rem;}
  @media(max-width:900px){ main{grid-template-columns:1fr;} .toc{order:2} }
  .card{background:var(--card-bg); padding:1rem; border-radius:var(--radius); box-shadow:0 6px 18px rgba(10,10,10,0.06);}
  .section-title{display:flex; justify-content:space-between; align-items:center;}
  .voices{display:flex; gap:.5rem; margin-top:.75rem; flex-wrap:wrap;}
  .voice-btn{padding:.3rem .5rem;border-radius:6px;border:1px solid #eee;background:#fafafa; cursor:pointer; font-size:.95rem}
  .fractal-links{margin-top:1rem}
  .toc{position:sticky; top:1rem;}
  footer{margin-top:2rem; padding:1rem 0; color:var(--muted); font-size:.9rem;}
  .muted{color:var(--muted)}
  .big{font-size:1.15rem}
  .high-contrast{background:black; color:yellow}
  .large-text{font-size:1.25rem}
  .simple-mode{font-family:Georgia,serif}
  .btn{padding:.5rem .8rem;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
  .secondary{background:#eee;color:var(--fg)}
  .bib-list{max-height:40vh; overflow:auto; padding:.5rem; border-radius:8px; background:#fafafa;}
  .export{margin-left: .5rem}
  /* accessibility focus */
  :focus{outline:3px solid #ffd54f; outline-offset:2px}
</style>
</head>
<body>
<div class="container" id="app">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true">–ë</div>
      <div>
        <div style="font-weight:700">–•—Ä–æ–Ω–∏–∫–∏ –ë–µ–ª–ª–∞–º–∞—Ä–∞</div>
        <div class="muted" style="font-size:.85rem">Fractal Meta-Science Narrative ‚Äî prototype</div>
      </div>
    </div>

    <div style="display:flex; gap:.6rem; align-items:center;">
      <nav aria-label="Main navigation" id="nav">
        <button class="lang-btn" data-lang="ru">RU</button>
        <button class="lang-btn" data-lang="en">EN</button>
        <button class="lang-btn" data-lang="uz">UZ</button>
        <button class="lang-btn" data-lang="ug">UY</button>
        <button class="lang-btn" data-lang="de">DE</button>
      </nav>

      <div class="controls">
        <button id="tts-play" class="btn" title="Play text (TTS)">‚ñ∂Ô∏è</button>
        <button id="tts-stop" class="secondary" title="Stop TTS">‚ñ†</button>
        <button id="contrast" class="secondary" title="Toggle high contrast">Contrast</button>
        <button id="size" class="secondary" title="Toggle large text">A+</button>
        <button id="simple" class="secondary" title="Simple/Illustrated mode">Simple</button>
        <button id="export-md" class="secondary export" title="Export current view to Markdown">Export MD</button>
      </div>
    </div>
  </header>

  <main>
    <section aria-labelledby="content" id="content-area">
      <!-- Sections populated by JS -->
    </section>

    <aside class="toc card" id="sidebar" aria-label="Sidebar">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;">
        <strong>–ù–∞–≤–∏–≥–∞—Ü–∏—è / Navigation</strong>
        <span class="muted small" id="lang-indicator">RU</span>
      </div>

      <div id="toc-list">
        <!-- TOC injected -->
      </div>

      <hr style="margin:.75rem 0"/>

      <div>
        <strong>–ë–∏–±–ª–∏–æ–≥—Ä–∞—Ñ–∏—è / Bibliography (APA7)</strong>
        <div class="bib-list" id="bib">
          <!-- Bibliography entries -->
        </div>
        <div style="margin-top:.5rem">
          <button id="more-bib" class="secondary" style="width:100%;">–î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ / Add sources</button>
        </div>
      </div>

    </aside>
  </main>

  <footer class="muted">
    –ü—Ä–æ—Ç–æ—Ç–∏–ø ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ "–•—Ä–æ–Ω–∏–∫–∏ –ë–µ–ª–ª–∞–º–∞—Ä–∞". –¢–µ–∫—Å—Ç ‚Äî –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π. –î–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ –º–µ–¥–∏–∞. &nbsp;|&nbsp; <span id="status">–ì–æ—Ç–æ–≤–æ</span>
  </footer>
</div>

<script>
/* ========== Data: multilingual skeleton content ========== */
const CONTENT = {
  ru: {
    title: "–•—Ä–æ–Ω–∏–∫–∏ –ë–µ–ª–ª–∞–º–∞—Ä–∞",
    sections: [
      { id:'cosmo', title:'I. –ö–æ—Å–º–æ–≥–æ–Ω–∏—è –∏ –∞—Ä—Ö–µ—Ç–∏–ø—ã', blocks: [
        {mode:'academic', heading:'[–§–ê–ö–¢] –ö–æ—Å–º–æ–≥–æ–Ω–∏—è: –∞—Ä—Ö–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∏ –º–∏—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∏', text:
`[–§–ê–ö–¢] –ú–∏—Ñ—ã –æ —Å–æ—Ç–≤–æ—Ä–µ–Ω–∏–∏ –º–∏—Ä–∞ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –≤ —Å–∞–º—ã—Ö —Ä–∞–Ω–Ω–∏—Ö –ø–∏—Å—å–º–µ–Ω–Ω—ã—Ö –∏ —É—Å—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö ‚Äî –æ—Ç –í–µ–¥, –≠–ø–æ–Ω–∏–º –¥–æ –æ—Ä—Ö–æ–Ω—Å–∫–∏—Ö —Ä—É–Ω–∏—á–µ—Å–∫–∏—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤. [–§–ú–ü-–ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø] –í –º–æ–¥–µ–ª–∏ –§–ú–ü –∞—Ä—Ö–µ—Ç–∏–ø "—è–π—Ü–æ / –¥—Ä–µ–≤–æ" –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ: –º–∏–∫—Ä–æ–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä—è—é—Ç –º–∞–∫—Ä–æ—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.`},
        {mode:'epic', heading:'–≠–ø–∏—á–µ—Å–∫–æ–µ', text:'–°—Ç–µ–ø—å –ø–ª–∞—á–µ—Ç –∏ –ø–æ—ë—Ç; –Ω–µ–±–æ –¥–∞—ë—Ç –∏–º—è –≤–µ—Ç—Ä—É; —è–π—Ü–æ –º–∏—Ä–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å–∫–æ–ª–æ–ª–æ—Å—å ‚Äî –∏ –≤ —Ç—Ä–µ—â–∏–Ω–∞—Ö –ø–æ—è–≤–∏–ª–∏—Å—å –≥–æ—Ä–æ–¥–∞.'},
        {mode:'artifact', heading:'–ì–æ–ª–æ—Å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ ‚Äî –Ø–π—Ü–æ', text:'–Ø ‚Äî —Å–∫–æ—Ä–ª—É–ø–∞, –≤ –º–æ–µ–π —Ç—Ä–µ—â–∏–Ω–µ ‚Äî –ø–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–∞ –¥–æ—Ä–æ–≥. –ö–æ–º—É —è –æ—Ç–∫—Ä–æ—é –ø—É—Ç—å?'},
      ]},
      { id:'material', title:'II. –ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–∞—è –∫—É–ª—å—Ç—É—Ä–∞ –∫–∞–∫ –∫–æ–¥ —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–∏', blocks: [
        {mode:'academic', heading:'–°—Ç—Ä–µ–º—è –∏ –º–µ—Ç–∞–ª–ª—É—Ä–≥–∏—è', text:'[–§–ê–ö–¢] –°—Ç—Ä–µ–º—è –∫–∞–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∏–Ω–Ω–æ–≤–∞—Ü–∏—è —Ä–∞–¥–∏–∫–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–∞ –º–æ–±–∏–ª—å–Ω–æ—Å—Ç—å –æ–±—â–µ—Å—Ç–≤–∞; –¥–∞–º–∞—Å—Å–∫–∞—è —Å—Ç–∞–ª—å, —Ñ–µ—Ä–≥–∞–Ω—Å–∫–∏–µ –∫—É–∑–Ω–∏—Ü—ã ‚Äî –∫–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–π –∫—É–ª—å—Ç—É—Ä—ã.'},
        {mode:'artifact', heading:'–ì–æ–ª–æ—Å: –°—Ç—Ä–µ–º—è', text:'–Ø ‚Äî —Å—Ç—Ä–µ–º—è –∏–∑ –ê–ª—Ç–∞—è. –î–æ –º–µ–Ω—è –≤—Å–∞–¥–Ω–∏–∫ –±—ã–ª –≥–æ—Å—Ç–µ–º, –ø–æ—Å–ª–µ ‚Äî —Ö–æ–∑—è–∏–Ω–æ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞.'},
      ]},
      { id:'history', title:'III. –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—Ä–æ–¥–æ–≤ (—Ñ—Ä–∞–∫—Ç–∞–ª—å–Ω–∞—è –ø—Ä–∏–∑–º–∞)', blocks: [
        {mode:'academic', heading:'–£–π–≥—É—Ä—Å–∫–∏–µ –∫–∞–≥–∞–Ω–∞—Ç—ã –∏ –ø–∏—Å—å–º–æ–≤–æ–¥–∏—Ç–µ–ª–∏', text:'[–§–ê–ö–¢] –£–π–≥—É—Ä—Å–∫–∏–π –∫–∞–≥–∞–Ω–∞—Ç (744‚Äì840) —Å–æ–∑–¥–∞–ª –ø–∏—Å—å–º–µ–Ω–Ω—ã–µ —Ç—Ä–∞–¥–∏—Ü–∏–∏ –∏ –±—é—Ä–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏; –ø–∏—Å—å–º–æ–≤–æ–¥–∏—Ç–µ–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—á–µ–≤—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –≤ –æ—Å–µ–¥–ª—ã–µ –∏–º–ø–µ—Ä—Å–∫–∏–µ —Ñ–æ—Ä–º—ã.'},
        {mode:'epic', heading:'–≠–ø–∏—á–µ—Å–∫–æ–µ', text:'–û—Ä–¥—É-–ë–∞–ª—ã–∫ —Å—Ç–æ–∏—Ç –Ω–∞ –≤–µ—Ç—Ä—É. –ö–∞–º–Ω–∏ —à–µ–ø—á—É—Ç –∏–º–µ–Ω–∞ —Ç–µ—Ö, –∫—Ç–æ —Å—á–∏—Ç–∞–ª —Å–ª–æ–≤–∞ —Å–æ–∫—Ä–æ–≤–∏—â–µ–º.'},
        {mode:'personal', heading:'–õ–∏—á–Ω—ã–π –≥–æ–ª–æ—Å', text:'[–°–ï–ú–ï–ô–ù–û–ï –ü–†–ï–î–ê–ù–ò–ï] –ú–æ–π –¥–µ–¥ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–ª –æ —Ç–∞–±–∞—á–Ω–æ–π —Ñ–∞–±—Ä–∏–∫–µ –≤ –ö—É–ª—å–¥–∂–µ; –≤ –µ–≥–æ –ø–∞–º—è—Ç–∏ ‚Äî –æ—Ç—Ç–µ–Ω–∫–∏ —Å—Ç–∞—Ä–æ–≥–æ –º–∏—Ä–∞.'},
      ]},
      { id:'bio', title:'IV. –õ–∏—á–Ω–∞—è –±–∏–æ–≥—Ä–∞—Ñ–∏—è –∫–∞–∫ –º–∏–∫—Ä–æ–∫–æ—Å–º', blocks: [
        {mode:'personal', heading:'–†–æ–∂–¥–µ–Ω–∏–µ –∏ –∫–æ—Ä–Ω–∏', text:'[–§–ê–ö–¢] –ê–±–¥—É—Ä–∞—à–∏–¥ –ê–±–¥—É–∫–∞—Ä–∏–º–æ–≤ ‚Äî —Ä–æ–¥–∏–ª—Å—è 22.03.1977 –≤ –¢–∞—à–∫–µ–Ω—Ç–µ. [–§–ú–ü-–ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø] –õ–∏—á–Ω–∞—è –±–∏–æ–≥—Ä–∞—Ñ–∏—è –∫–∞–∫ –≥–æ–ª–æ–≥—Ä–∞–º–º–∞ —ç–ø–æ—Ö–∏.'},
        {mode:'epic', heading:'–≠–ø–∏—á–µ—Å–∫–æ–µ', text:'–ú–∞–ª–µ–Ω—å–∫–∏–π –≥–æ—Ä–æ–¥, –±–æ–ª—å—à–∞—è –ø–∞–º—è—Ç—å ‚Äî –∫–∞–∂–¥–∞—è —Ç—Ä–µ—â–∏–Ω–∞ –∫–∏—Ä–ø–∏—á–∞ —Ö—Ä–∞–Ω–∏—Ç –∏–º—è.'},
      ]},
      { id:'meta', title:'V. –ú–µ—Ç–∞—Ä–µ—Ñ–ª–µ–∫—Å–∏—è –∏ –§–ú–ü', blocks: [
        {mode:'academic', heading:'–§—Ä–∞–∫—Ç–∞–ª—å–Ω–∞—è –ú–µ—Ç–∞–Ω–∞—É—á–Ω–∞—è –ü–∞—Ä–∞–¥–∏–≥–º–∞ (–§–ú–ü)', text:'–§–ú–ü ‚Äî –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –Ω–∞–±–æ—Ä: —Ñ—Ä–∞–∫—Ç–∞–ª—å–Ω–∞—è —Å–∞–º–æ-–ø–æ–¥–æ–±–Ω–æ—Å—Ç—å, —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —Å–æ-–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, —ç–º–µ—Ä–¥–∂–µ–Ω—Ç–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –∫–∞–∫ —Ç–µ—Ä—Ä–∞–ø–µ–¥–∏–∏.'},
        {mode:'artifact', heading:'–ì–æ–ª–æ—Å: –ö–Ω–∏–≥–∞', text:'–Ø ‚Äî –∫–Ω–∏–≥–∞, –∏ –≤ –∫–∞–∂–¥–æ–π –º–æ–µ–π —Å—Ç—Ä–æ–∫–µ –æ—Ç—Ä–∞–∂–∞–µ—Ç—Å—è —Ü–µ–ª—ã–π –º–∏—Ä.'},
      ]},
    ]
  },

  en: {
    title: "Chronicles Bellamar",
    sections: [
      { id:'cosmo', title:'I. Cosmogony and Archetypes', blocks: [
        {mode:'academic', heading:'[FACT] Cosmogony: archaeological & mythic layers', text:
`[FACT] Creation myths appear in the earliest textual and oral sources ‚Äî from Vedic hymns to rune-fragments. [FMP-INTERPRETATION] In FMP, the 'egg/tree' archetype repeats recursively: micro-patterns mirror macro-structures.`},
        {mode:'epic', heading:'Epic', text:'The steppe breathes and sings; the sky names the wind; the cosmic egg broke and cities spilled out.'},
        {mode:'artifact', heading:'Artifact Voice ‚Äî The Egg', text:'I am a shell; in my crack is the first map of roads. Whom will I lead?'},
      ]},
      { id:'material', title:'II. Material Culture as Civilization Code', blocks: [
        {mode:'academic', heading:'Stirrup & metallurgy', text:'[FACT] The stirrup was a mobility revolution; Damascus steel and Fergana forges are core elements of material culture.'},
        {mode:'artifact', heading:'Voice: Stirrup', text:'I am the stirrup forged in Altai. Before me the rider was guest; after me ‚Äî master of horizon.'},
      ]},
      { id:'history', title:'III. Peoples in Fractal Prism', blocks: [
        {mode:'academic', heading:'Uighur Khaganates & scribes', text:'[FACT] The Uighur Khaganate (744‚Äì840) developed scripts and bureaucratic practices; scribes translated nomadic administration into imperial forms.'},
        {mode:'epic', heading:'Epic', text:'Ordu-Balyk stands to the wind. Stones whisper names of those who treasured words.'},
        {mode:'personal', heading:'Personal voice', text:'[FAMILY TRADITION] My grandfather spoke of a tobacco factory in Kuldja; in his memory ‚Äî shades of an old world.'},
      ]},
      { id:'bio', title:'IV. Personal Biography as Microcosm', blocks: [
        {mode:'personal', heading:'Birth and roots', text:'[FACT] Abdurashid Abdukarimov ‚Äî born 22.03.1977, Tashkent. [FMP-INTERPRETATION] Biography as hologram of an epoch.'},
      ]},
      { id:'meta', title:'V. Metareflection & FMP', blocks: [
        {mode:'academic', heading:'Fractal Meta-Scientific Paradigm (FMP)', text:'FMP is a methodological set: fractal self-similarity, recursive co-construction, emergent integration. Use: organize the text as a terrapedia.'},
      ]},
    ]
  },

  uz: {
    title: "Bellamar Xronikalari",
    sections: [
      { id:'cosmo', title:'I. Kosmogoniya va arxetiplar', blocks:[
        {mode:'academic', heading:'[FAKT] Kosmogoniya', text:'[FAKT] Dunyo yaratish haqidagi miflar qadimgi matn va og‚Äòzaki manbalarda saqlanadi. [FMP-TALQINI] FMPda "tuxum/daraxt" arxetipi rekursiv takrorlanadi.'},
        {mode:'epic', heading:'Epos', text:'Dasht nafas oladi; osmon shamolga ism beradi; tuxum yorilib, shaharlar paydo bo‚Äòldi.'}
      ]},
      { id:'material', title:'II. Madaniy material ‚Äî sivilizatsiya kodi', blocks:[
        {mode:'academic', heading:'Tirman va metallurgiya', text:'[FAKT] Tirman ‚Äî harakat inqilobi; Damashq po‚Äòlat va Farg‚Äòona kuymalari moddiy madaniyat asosini tashkil qiladi.'}
      ]},
    ]
  },

  ug: { /* Uyghur (simplified samples) */
    title: "ÿ®€êŸÑŸÑÿßŸÖÿßÿ± ÿÆŸâÿ±ŸàŸáŸâŸÜŸâŸÉŸÑŸâÿ±Ÿâ",
    sections: [
      { id:'cosmo', title:'I. ÿÆÿßŸÑŸâŸÇ ÿ®€ÜŸÑ€àÿ¥ €ã€ï ÿ¶ÿßŸÑÿÆ€ïÿ™ŸÑ€ïÿ±', blocks:[
        {mode:'academic', heading:'[ŸÅ€ïŸÉÿ™Ÿâ] ÿÆÿßŸÑŸâŸÇ ÿ®€ÜŸÑ€àÿ¥', text:'[ŸÅ€ïŸÉÿ™Ÿâ] ÿÆÿßŸÑŸâŸÇ ÿ®€ÜŸÑ€àÿ¥ ŸÖŸâÿ™Ÿâÿ±ŸâŸÉŸÑŸâÿ±Ÿâ ÿ¶€ï⁄≠ ÿ¶ÿßŸÑÿØŸâŸÜŸÇŸâ Ÿä€êÿ≤ŸâŸÇ €ã€ï ÿ¶ÿß€ãÿßÿ≤ŸÑŸâŸÇ ŸÖ€ïŸÜÿ®€ïŸÑ€ïÿ±ÿØ€ï ŸÉ€Üÿ±€àŸÑÿØŸâ. [FMP] "ÿ™ŸàÿÆ€áŸÖ/ÿØ€ïÿ±€ïÿÆ" ÿ¶ÿßŸÑÿÆ€ïÿ™ŸÑŸâŸÉ ŸÇÿßŸÑÿ™Ÿâÿ≥ŸÑŸâŸÇŸÜŸâ ÿ™€ïŸÉÿ±ÿßÿ±ŸÑÿßŸäÿØ€á.'}
      ]}
    ]
  },

  de: {
    title: "Chroniken Bellamar",
    sections: [
      { id:'cosmo', title:'I. Kosmogonie und Archetypen', blocks:[
        {mode:'academic', heading:'[FAKT] Kosmogonie: arch√§ologische & mythische Schichten', text:'[FAKT] Sch√∂pfungsmythen sind in fr√ºhen Texten und M√ºndlichen √úberlieferungen verzeichnet. [FMP-INTERPRETATION] Im FMP wiederholt sich das Archetyp "Ei/Baum" rekursiv.'}
      ]}
    ]
  }
};

/* ========== Bibliography (APA7) ========== */
const BIBLIOGRAPHY = [
  "Anthony, D. W. (2007). The Horse, the Wheel, and Language: How Bronze-Age Riders from the Eurasian Steppes Shaped the Modern World. Princeton University Press.",
  "Golden, P. B. (1992). An Introduction to the History of the Turkic Peoples. Otto Harrassowitz.",
  "Kramer, S. N. (1963). The Sumerians: Their History, Culture, and Character. University of Chicago Press.",
  "Postgate, J. N. (1992). Early Mesopotamia: Society and Economy at the Dawn of History. Routledge.",
  "Van de Mieroop, M. (2007). A History of the Ancient Near East. Blackwell.",
  "Cooper, J. S. (2001). Sumerian and Akkadian Tablets in the British Museum. British Museum Press.",
  "Shaw, I. (2000). The Oxford History of Ancient Egypt. Oxford University Press.",
  "Wilkinson, T. A. H. (2003). The Complete Temples of Ancient Egypt. Thames & Hudson.",
  "Kemp, B. (2006). Ancient Egypt: Anatomy of a Civilization. Routledge.",
  "Possehl, G. L. (2002). The Indus Civilization: A Contemporary Perspective. Rowman & Littlefield.",
  "Kenoyer, J. M. (1998). Ancient Cities of the Indus Valley Civilization. Oxford University Press.",
  "Thapar, R. (2002). Early India: From the Origins to AD 1300. University of California Press.",
  "Keightley, D. (1978). Sources of Shang History: The Oracle-Bone Inscriptions of Bronze Age China. University of California Press.",
  "Bagley, R. (1999). Shang Archaeology. In The Cambridge History of Ancient China. Cambridge University Press.",
  "Evans, A. (1949). The Palace of Minos. London: Macmillan.",
  "Chadwick, J. (1976). The Mycenaean World. Cambridge University Press.",
  "Cline, E. H. (2014). 1177 B.C.: The Year Civilization Collapsed. Princeton University Press.",
  "Mallory, J. P. (1999). The Origins of the Indo-Europeans: Language, Archaeology, and Myth. Thames & Hudson.",
  "Liverani, M. (1998). International Relations in the Ancient Near East. Palgrave.",
  "Benecke, N. (2005). Archaeozoology of early horse domestication. Journal articles and edited volumes.",
  "Outram, A. K., et al. (2009). The Earliest Horse Harnessing and Riding Evidence From Botai. Antiquity / Science articles.",
  "Millward, J. (2007). Eurasian Crossroads: A History of Xinjiang. Columbia University Press.",
  "Mackerras, C. (1990). The Uighur Empire 744‚Äì840. In various historical compendia.",
  "Tekin, T. (1968). Orkhon Inscriptions. Indiana University Publications.",
  "Golden, P. B. (2011). Central Asia in World History. Oxford University Press.",
  "Brodie, N. (2010). Metallurgy and early steel techniques in Central Asia. (Collection).",
  "Snodgrass, A. (1971). The Mycenaean World. Oxford University Press.",
  "Castleden, R. (1990). The Knossos Labyrinth. Routledge.",
  "W3C. (2018). Web Content Accessibility Guidelines (WCAG) 2.1. World Wide Web Consortium.",
  "UNESCO. (2003). Convention for the Safeguarding of the Intangible Cultural Heritage.",
  "Navoi, A. (15th c.). Guly va Navruz (selected translations)."
];

/* ========== UI logic ========== */
const app = document.getElementById('app');
const contentArea = document.getElementById('content-area');
const tocList = document.getElementById('toc-list');
const bibList = document.getElementById('bib');
const langButtons = document.querySelectorAll('[data-lang]');
const langIndicator = document.getElementById('lang-indicator');
let currentLang = 'ru';
let currentSectionId = null;

/* render functions */
function renderSidebarBib() {
  bibList.innerHTML = '';
  BIBLIOGRAPHY.forEach((b, i) => {
    const li = document.createElement('div');
    li.style.marginBottom='0.6rem';
    li.innerHTML = `<div style="font-size:.95rem">${i+1}. ${escapeHtml(b)}</div>`;
    bibList.appendChild(li);
  });
}

function renderContent(lang) {
  contentArea.innerHTML = ''; tocList.innerHTML='';
  const page = CONTENT[lang] || CONTENT['ru'];
  document.title = page.title + ' ‚Äî Prototype';
  document.querySelector('.brand div strong').textContent = page.title || 'Chronicles Bellamar';
  langIndicator.textContent = lang.toUpperCase();

  page.sections.forEach((sec, idx) => {
    // add to TOC
    const tocItem = document.createElement('div');
    tocItem.innerHTML = `<a href="#${sec.id}" style="text-decoration:none;color:var(--accent)">${idx+1}. ${sec.title}</a>`;
    tocList.appendChild(tocItem);

    // create section card
    const secCard = document.createElement('div');
    secCard.className='card';
    secCard.id = sec.id;
    const header = document.createElement('div');
    header.className='section-title';
    header.innerHTML = `<h2 style="margin:0">${idx+1}. ${sec.title}</h2><div class="muted">–§—Ä–∞–∫—Ç–∞–ª: ${idx+1}</div>`;
    secCard.appendChild(header);

    // blocks: multiple voices
    sec.blocks.forEach((blk) => {
      const block = document.createElement('div');
      block.style.borderTop='1px dashed #eee'; block.style.marginTop='.75rem'; block.style.paddingTop='.6rem';
      block.setAttribute('role','article');
      block.innerHTML = `<div style="font-weight:600; margin-bottom:.25rem">${escapeHtml(blk.heading || '')}</div>
        <div class="muted">${escapeHtml(blk.mode.toUpperCase())}</div>
        <div class="big" style="margin-top:.4rem">${escapeHtml(blk.text)}</div>`;

      // voice buttons
      const voicesDiv = document.createElement('div');
      voicesDiv.className='voices';
      const playBtn = document.createElement('button'); playBtn.className='voice-btn'; playBtn.textContent='üîä –ü—Ä–æ—Å–ª—É—à–∞—Ç—å';
      playBtn.addEventListener('click', ()=> speak(blk.text, currentLang));
      voicesDiv.appendChild(playBtn);

      const copyBtn = document.createElement('button'); copyBtn.className='voice-btn secondary'; copyBtn.textContent='üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
      copyBtn.addEventListener('click', ()=> { navigator.clipboard.writeText(blk.text); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä');});
      voicesDiv.appendChild(copyBtn);

      const simpleBtn = document.createElement('button'); simpleBtn.className='voice-btn'; simpleBtn.textContent='üß≠ –§—Ä–∞–∫—Ç–∞–ª-—Å–≤—è–∑–∏';
      simpleBtn.addEventListener('click', ()=> alert('–°–≤—è–∑–∏: (–¥–µ–º–æ) ‚Äî —Å–º. –±–æ–∫–æ–≤—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é'));
      voicesDiv.appendChild(simpleBtn);

      block.appendChild(voicesDiv);
      secCard.appendChild(block);
    });

    // fractal links placeholder
    const fractal = document.createElement('div'); fractal.className='fractal-links muted';
    fractal.innerHTML = `<div><em>–§—Ä–∞–∫—Ç–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏:</em> —Å–º. —Å–º–µ–∂–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã ‚Äî <a href="#meta">V</a>, <a href="#material">II</a></div>`;
    secCard.appendChild(fractal);

    contentArea.appendChild(secCard);
  });
}

/* escape */
function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* TTS */
let synth = window.speechSynthesis;
function speak(text, lang){
  if(!synth){ alert('TTS –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ'); return;}
  synth.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  // map lang to speech codes (best-effort)
  const map = { ru:'ru-RU', en:'en-US', uz:'uz-UZ', ug:'ug-CN', de:'de-DE' };
  utter.lang = map[lang] || 'ru-RU';
  utter.rate = 1.0; utter.pitch = 1.0;
  synth.speak(utter);
}

/* UI events */
document.getElementById('tts-play').addEventListener('click', ()=> {
  // read visible first big block
  const first = document.querySelector('.card .big');
  if(first) speak(first.textContent, currentLang);
});
document.getElementById('tts-stop').addEventListener('click', ()=> synth && synth.cancel());

document.getElementById('contrast').addEventListener('click', ()=> {
  document.body.classList.toggle('high-contrast');
});
document.getElementById('size').addEventListener('click', ()=> {
  document.body.classList.toggle('large-text');
});
document.getElementById('simple').addEventListener('click', ()=> {
  document.body.classList.toggle('simple-mode');
});

langButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const lang = btn.getAttribute('data-lang');
    currentLang = lang;
    renderContent(lang);
  });
});

/* export to markdown (basic) */
document.getElementById('export-md').addEventListener('click', ()=>{
  const page = CONTENT[currentLang] || CONTENT['ru'];
  let md = `# ${page.title}\n\n`;
  page.sections.forEach((s,si)=>{
    md += `## ${si+1}. ${s.title}\n\n`;
    s.blocks.forEach(b=>{
      md += `### ${b.heading}\n\n`;
      md += `${b.text}\n\n`;
    });
  });
  const blob = new Blob([md], {type:'text/markdown;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = `${page.title.replace(/\s+/g,'_')}.md`; a.click();
  URL.revokeObjectURL(url);
});

/* add more sources (demo auto-append) */
document.getElementById('more-bib').addEventListener('click', ()=>{
  // append placeholder entries to simulate endless growth
  BIBLIOGRAPHY.push("Additional Source (auto) ‚Äî added " + new Date().toISOString());
  renderSidebarBib();
});

/* initial render */
renderSidebarBib();
renderContent(currentLang);

/* keyboard accessibility: quick nav (1-5) */
window.addEventListener('keydown',(e)=>{
  if(e.altKey && !e.shiftKey){
    const num = parseInt(e.key,10);
    if(num>=1 && num<=9){
      const page = CONTENT[currentLang] || CONTENT['ru'];
      const sec = page.sections[num-1];
      if(sec) { location.hash = '#'+sec.id; }
    }
  }
});

/* placeholders: integrate external media (comments) */
/*
  TODOs for full system:
  - connect to external bibliographic APIs (CrossRef, PubMed, WorldCat) to auto-expand APA7 entries
  - implement sign-language video widgets (upload or CDN links), automated captions (WebVTT)
  - add simplified audio-visual storytelling mode for low-literacy users (icons + audio + sequences)
  - implement graph visualization for fractal links (d3.js)
  - integrate server-side endpoint for continuous bibliographic ingestion and translation pipeline
*/

</script>
</body>
</html>
